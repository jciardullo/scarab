<?xml version="1.0" encoding="ISO-8859-15"?>
<launch>

  <arg name="ground_truth" default="true"/> <!-- publish ground truth tf tree -->
  <arg name="agent" default="husky"/>
  <arg name="laser" default="true"/>

  <!-- tf args -->
  <arg name="base_frame"    default="$(arg agent)/base" />
  <arg name="odom_frame"    default="$(arg agent)/odom" />
  <arg name="map_frame"     default="$(arg agent)/map" />
  <arg name="ground_truth_frame" default="ground_truth/$(arg base_frame)"/>
  <arg name="world_frame"   default="world"/>
  <arg name="publish_world" default="true"/>

  <!-- start unity -->
  <include file="$(find arl_unity_ros_ground)/launch/simulator_with_husky.launch">
    <arg name="simulator_param_file" value="$(find scarab_unity)/config/tutorial.yaml"/>
  </include>

  <!-- start rviz -->
  <node name="rviz" pkg="rviz" type="rviz"
        args="-d $(find scarab_unity)/launch/scarab.rviz"/>

  <!-- publish static transform between map_frame and odom_frame -->
  <node pkg="tf2_ros"
        type="static_transform_publisher"
        name="map_static_tf_broadcaster"
        args="0 0 0 0 0 0 $(arg map_frame) $(arg odom_frame)"/>

  <!-- publish static transform between ground_truth_frame and map_frame -->
  <node pkg="tf2_ros"
        type="static_transform_publisher"
        name="ground_static_tf_broadcaster"
        args="0 0 0 0 0 0 $(arg ground_truth_frame) $(arg map_frame)"
        if="$(arg publish_world)"/>

  <group ns="$(arg agent)">

    <!-- ground truth pose -->
    <node name="pose_stamped" pkg="hfn" type="tf_posestamped_node.py" >
      <param name="base_frame_id" value="$(arg base_frame)" />
      <param name="map_frame_id"  value="$(arg map_frame)" />
    </node>

    <!--hack to get laser frame correct
    <node pkg="tf2_ros"
          type="static_transform_publisher"
          name="base_static_tf_broadcaster"
          args="0 0 0 0 0 0 husky husky/scan"
          if="$(arg laser)"/> -->

    <!-- pointcloud to laserscan -->
    <arg name="node_start_delay" default="10.0" />
    <node name="cloud_to_laser" pkg="pointcloud_to_laserscan"
      type="pointcloud_to_laserscan_node"
      launch-prefix="bash -c 'sleep $(arg node_start_delay); $0 $@' " >
      <remap from="cloud_in" to="lidar_points" />
    </node>

    <!-- convert rviz goal msg to action -->
    <node name="goal_to_action" pkg="hfn" type="goal_to_action.py">
      <remap from="goal" to="move_base_simple/goal"/>
    </node>

    <!-- navigation via hfn -->
    <node name="hfn_navigation" pkg="hfn" type="hfn" output="screen">
      <remap from="odom" to="odometry/filtered"/>
      <param name="base_frame_id"      value="$(arg base_frame)"/>
      <param name="map_frame_id"       value="$(arg map_frame)" />
      <param name="cost_occ_prob"      value="0.7" />
      <param name="cost_occ_dist"      value="0.7" />
      <param name="max_occ_dist"       value="1.0" />
      <param name="lethal_occ_dist"    value="0.2" />
      <param name="axle_width"         value="0.57" />
      <param name="robot_radius"       value="0.52" />
      <param name="safety_margin"      value="0.1" />
      <param name="social_margin"      value="0.2" />
      <param name="goal_tolerance_ang" value=".05"/> <!--default 2pi-->
      <param name="goal_tolerance"     value=".05"/>     <!--default .2m-->
    </node>

    <!-- slam for localization -->
    <node pkg="gmapping" type="slam_gmapping" name="gmapping" output="screen">
      <remap from="map_metadata" to="map_metadata"/>

      <param name="base_frame" value="$(arg base_frame)" />
      <param name="odom_frame" value="$(arg odom_frame)"/>
      <param name="map_frame"  value="$(arg map_frame)" />
    </node>

  </group>

</launch>
